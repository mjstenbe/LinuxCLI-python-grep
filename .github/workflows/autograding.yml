name: Autograding

on: [push, pull_request]

jobs:
  autograde:
    runs-on: ubuntu-latest

    env:
      RESULTS_REPO_TOKEN: ${{ secrets.RESULTS_REPO_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run autograding
        id: grade
        run: python3 harjoitus.py --check
        continue-on-error: true

      - name: Upload autograde report
        uses: actions/upload-artifact@v4
        with:
          name: autograde-report
          path: output/results.json

      - name: Upload results to central repo
        run: |
          STUDENT=$(basename "$GITHUB_REPOSITORY")
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H-%M-%S")

          curl -X PUT \
            -H "Authorization: Bearer $RESULTS_REPO_TOKEN" \
            -H "Content-Type: application/json" \
            --data-binary @results.json \
            "https://api.github.com/repos/Laurea-ammattikorkeakoulu-Tikkurila/linux-assignments-autogradings-repo/contents/${STUDENT}-${TIMESTAMP}.json"

      - name: Fail workflow if grading failed
        if: steps.grade.outcome == 'failure'
        run: exit 1
